<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Wandercode Play mit Sensor</title>
  <style>
    body { font-family: sans-serif; padding: 1rem; }
    textarea { width: 100%; height: 150px; }
    #gameArea > * { margin: .5rem 0; }
    img { max-width: 100%; }
    #debugPanel { 
      background: #f9f9f9; 
      border: 1px solid #ccc; 
      padding: .5rem; 
      margin-top: 1rem; 
      font-family: monospace;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>

  <h1 id="titel">Gib dein Bound-JSON ein und starte:</h1>
  <textarea id="textInput">
{
  "title": "Meine Gurkenmission",
  "stations": [
    {
      "id": 1,
      "type": "question",
      "text": "Wie viele LÃ¶cher hat eine Socke?",
      "answer": "5",
      "imageUrl": "https://via.placeholder.com/150"
    },
    {
      "id": 2,
      "type": "gpsSound",
      "text": "Gehe zur Gurkenzentrale in Bern.",
      "lat": 46.948,
      "lng": 7.447,
      "radius": 50,
      "imageUrl": "https://via.placeholder.com/150"
    }
  ]
}
  </textarea><br>
  <button id="startBtn">Bound starten</button>

  <div id="gameArea"></div>

  <!-- Sheikah-Ping-Sound -->
  <audio id="pingSound" preload="auto"
         src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_17cba0354b.mp3?filename=ping-82822.mp3">
  </audio>

  <!-- Debug-Panel -->
  <div id="debugPanel">
    <div id="headingDebug">Heading: â€“</div>
    <div id="bearingDebug">Bearing: â€“</div>
    <div id="deltaDebug">Delta: â€“</div>
    <div id="pingDebug">Ping-Status: â€“</div>
  </div>

  <script>
    // 1. Globaler State
    let stations = [], currentIdx = 0;
    let watchId = null, heading = null, soundInterval = null;

    // 2. Start-Button: Kompass-Permission + Audio-Unlock + Bound-Start
    document.getElementById('startBtn').onclick = async () => {
      const audio = document.getElementById('pingSound');

      // 2.1 Kompass-API (iOS 13+)
      if (DeviceOrientationEvent.requestPermission) {
        try {
          const resp = await DeviceOrientationEvent.requestPermission();
          if (resp !== 'granted') {
            alert('Kompass-Erlaubnis verweigert â€“ kein Sound-Feedback.');
          }
        } catch {
          alert('Kompass-API nicht verfÃ¼gbar.');
        }
      }

      // 2.2 Audio-Unlock (Autoplay-Policy umgehen)
      try {
        audio.muted = true;
        await audio.play();
        audio.pause();
        audio.muted = false;
      } catch {}

      // 2.3 JSON parsen & Bound initialisieren
      try {
        const bound = JSON.parse(document.getElementById('textInput').value);
        document.getElementById('titel').textContent = bound.title;
        stations = bound.stations;
        currentIdx = 0;
        document.getElementById('textInput').style.display = 'none';
        document.getElementById('startBtn').style.display = 'none';
        renderStation();
      } catch (e) {
        alert('UngÃ¼ltiges JSON: ' + e.message);
      }
    };

    // 3. Station rendern + Logik
    function renderStation() {
      const area = document.getElementById('gameArea');
      area.innerHTML = '';
      stopWatch(); stopSound();

      if (currentIdx >= stations.length) {
        area.innerHTML = '<h2>ðŸŽ‰ Bound abgeschlossen!</h2>';
        return;
      }
      const st = stations[currentIdx];

      // Bild-Hinweis
      if (st.imageUrl) {
        const img = document.createElement('img');
        img.src = st.imageUrl;
        area.appendChild(img);
      }

      // Text
      const p = document.createElement('p');
      p.textContent = st.text;
      area.appendChild(p);

      // Stationstyp
      if (st.type === 'question') {
        // Quiz
        const inp = document.createElement('input');
        const btn = document.createElement('button');
        btn.textContent = 'Antwort prÃ¼fen';
        btn.onclick = () => {
          if (inp.value.trim().toLowerCase() === st.answer.toLowerCase()) {
            currentIdx++; renderStation();
          } else {
            alert('Falsch â€“ versuchâ€™s nochmal.');
          }
        };
        area.append(inp, btn);

      } else if (st.type === 'gps') {
        // normaler GPS-Check
        startWatch();
        const btn = document.createElement('button');
        btn.textContent = 'Ziel erreicht?';
        btn.onclick = () => {
          navigator.geolocation.getCurrentPosition(pos => {
            const d = distance(pos.coords.latitude, pos.coords.longitude, st.lat, st.lng);
            if (d <= st.radius) {
              currentIdx++; renderStation();
            } else {
              alert(`Noch ${Math.round(d)} m bis zum Ziel.`);
            }
          }, () => alert('GPS-Fehler'));
        };
        area.appendChild(btn);

      } else if (st.type === 'gpsSound') {
        // GPS-Check + Sheikah-Ping
        startWatch();
        startSound(st);
        const btn = document.createElement('button');
        btn.textContent = 'Ziel erreicht?';
        btn.onclick = () => {
          navigator.geolocation.getCurrentPosition(pos => {
            const d = distance(pos.coords.latitude, pos.coords.longitude, st.lat, st.lng);
            if (d <= st.radius) {
              currentIdx++; renderStation();
            } else {
              alert(`Noch ${Math.round(d)} m bis zum Ziel.`);
            }
          }, () => alert('GPS-Fehler'));
        };
        area.appendChild(btn);
      }
    }

    // 4. Geolocation-Watcher starten/stoppen
    function startWatch() {
      stopWatch();
      watchId = navigator.geolocation.watchPosition(() => {}, () => {}, {
        enableHighAccuracy: true,
        maximumAge: 0,
        timeout: 2000
      });
    }
    function stopWatch() {
      if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
      }
    }

    // 5. Sheikah-Sensor: Dauerpiepen bei richtiger Richtung + Debug
    function startSound(st) {
      stopSound();
      const audio   = document.getElementById('pingSound');
      const hdgEl   = document.getElementById('headingDebug');
      const brgEl   = document.getElementById('bearingDebug');
      const deltaEl = document.getElementById('deltaDebug');
      const pingEl  = document.getElementById('pingDebug');

      soundInterval = setInterval(() => {
        navigator.geolocation.getCurrentPosition(pos => {
          if (heading === null) return;
          const lat = pos.coords.latitude, lng = pos.coords.longitude;
          const bear = bearing(lat, lng, st.lat, st.lng);
          const diff = shortestAngleDiff(heading, bear);

          hdgEl.textContent   = `Heading:      ${heading.toFixed(1)}Â°`;
          brgEl.textContent   = `Ziel-Bearing: ${bear.toFixed(1)}Â°`;
          deltaEl.textContent = `Differenz:    ${diff.toFixed(1)}Â°`;

          if (diff <= 36) {
            if (audio.paused) audio.play().catch(() => {});
            pingEl.textContent = 'ðŸ”Š Piepen aktiv';
          } else {
            if (!audio.paused) audio.pause();
            pingEl.textContent = 'ðŸ”‡ Piepen aus';
          }
        }, err => {
          console.warn('Geo-Fehler', err);
        }, {
          enableHighAccuracy: true,
          maximumAge: 0,
          timeout: 5000
        });
      }, 500); // alle 0.5 s prÃ¼fen
    }
    function stopSound() {
      if (soundInterval !== null) {
        clearInterval(soundInterval);
        soundInterval = null;
      }
      document.getElementById('pingDebug').textContent = '';
    }

    // 6. Kompass-Heading aktualisieren (zwei Events)
    ['deviceorientationabsolute', 'deviceorientation'].forEach(evt => {
      window.addEventListener(evt, e => {
        if (e.alpha != null) heading = (360 - e.alpha) % 360;
      });
    });

    // 7. Hilfsfunktionen

    function toRad(deg){ return deg * Math.PI/180; }
    function toDeg(rad){ return rad * 180/Math.PI; }

    // Haversine-Formel (Distanz in Metern)
    function distance(lat1, lon1, lat2, lon2) {
      const R = 6371000;
      const Ï†1 = toRad(lat1), Ï†2 = toRad(lat2);
      const Î”Ï† = toRad(lat2 - lat1), Î”Î» = toRad(lon2 - lon1);
      const a = Math.sin(Î”Ï†/2)**2 + Math.cos(Ï†1)*Math.cos(Ï†2)*Math.sin(Î”Î»/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    // Peilung (Azimut) berechnen
    function bearing(lat1, lon1, lat2, lon2) {
      const Ï†1 = toRad(lat1), Ï†2 = toRad(lat2);
      const Î”Î» = toRad(lon2 - lon1);
      const y = Math.sin(Î”Î»)*Math.cos(Ï†2);
      const x = Math.cos(Ï†1)*Math.sin(Ï†2)
              - Math.sin(Ï†1)*Math.cos(Ï†2)*Math.cos(Î”Î»);
      return (toDeg(Math.atan2(y, x)) + 360) % 360;
    }

    // Kleinster Winkel-Unterschied
    function shortestAngleDiff(a, b) {
      const d = Math.abs(a - b) % 360;
      return d > 180 ? 360 - d : d;
    }
  </script>
</body>
</html>

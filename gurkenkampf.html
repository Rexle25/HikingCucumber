<!DOCTYPE html>
<head>
    <title>Gurkenflucht</title>

     <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>

    <link rel="stylesheet" href="style.css">

</head>

<body>

    <div id="map"></div>

    <p id="attackTimer">Timer</p>

    <script>

        var map = L.map('map').setView([46.9480900, 7.4474400], 12);

        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);

        var greenIcon = L.icon({
            iconUrl: 'cucumber.png',
            shadowUrl: '',

            iconSize:     [70, 17], // size of the icon
            shadowSize:   [50, 64], // size of the shadow
            iconAnchor:   [0, 0], // point of the icon which will correspond to marker's location
            shadowAnchor: [4, 62],  // the same for the shadow
            popupAnchor:  [0, 0] // point from which the popup should open relative to the iconAnchor
        });

        function entfernungInMetern(lat1, lon1, lat2, lon2) {
            const R = 6371000;
            const toRad = x => x * Math.PI / 180;

            const dLat = toRad(lat2 - lat1);
            const dLon = toRad(lon2 - lon1);
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);

            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function randomGurkenSpawn(lat, lon, minDist, maxDist) {
            const R = 6371000;
            const θ = Math.random() * 2 * Math.PI;
            const d = Math.sqrt(Math.random() * (maxDist**2 - minDist**2) + minDist**2);

            const δ = d / R;
            const φ1 = lat * Math.PI / 180;
            const λ1 = lon * Math.PI / 180;

            const φ2 = Math.asin(Math.sin(φ1) * Math.cos(δ) +
                                Math.cos(φ1) * Math.sin(δ) * Math.cos(θ));
            
            const λ2 = λ1 + Math.atan2(Math.sin(θ) * Math.sin(δ) * Math.cos(φ1),
                                    Math.cos(δ) - Math.sin(φ1) * Math.sin(φ2));

            const newLat = φ2 * 180 / Math.PI;
            const newLon = λ2 * 180 / Math.PI;

            return [newLat, newLon];
        }

        

        let timer = 0;

        

        let vorherigeLat;
        let vorherigeLon;
        let playerLat;
        let PlayerLon;
        let player;
        let distToLastSpawn;
        let pause = false;
        let playerHP = 10;
        let unverwundbar = false;
        let lastPolygonLat;
        let lastPolygonLon;

        function unverwundbarStop() {
            unverwundbar = false;
        }

        navigator.geolocation.getCurrentPosition( pos => {

            player = L.circle([pos.coords.latitude, pos.coords.longitude], {
                color: 'red',
                fillColor: '#f03',
                fillOpacity: 0.5,
                radius: 10
            }).addTo(map);  

            vorherigeLon = pos.coords.longitude -0.001;
            vorherigeLat = pos.coords.latitude -0.001;
            lastPolygonLat = pos.coords.longitude -0.011;
            lastPolygonLon = pos.coords.latitude -0.011;
            



        });

        navigator.geolocation.watchPosition( pos => {
            playerLat = pos.coords.latitude;
            playerLon = pos.coords.longitude;

            player.setLatLng([playerLat, playerLon]);

            const dLat = playerLat - vorherigeLat;
            const dLon = playerLon - vorherigeLon;

            distToLastSpawn = entfernungInMetern(vorherigeLat, vorherigeLon, playerLat, playerLon);

            console.log(distToLastSpawn);

            if (distToLastSpawn > 100) {
                console.log("Feindliche Gurken werden Gespawnt");
                vorherigeLat = playerLat;
                vorherigeLon = playerLon;

                for (let i = 0; i < 5; i++) {

                    let gurkeHP = 15;

                    let [gurkenLat, gurkenLon] = randomGurkenSpawn(playerLat, playerLon, 30, 100);

                    let marker = L.marker([gurkenLat, gurkenLon], {icon: greenIcon}).addTo(map).on('click', function(e) {
                        const distToPlayer = entfernungInMetern(gurkenLat, gurkenLon, playerLat, playerLon);

                        if (distToPlayer < 20) {
                            if (timer > 5) {
                                gurkeHP = gurkeHP - timer;

                            }
                            
                            
                        }

                        if (gurkeHP < 0.001) {
                            map.removeLayer(marker); 
                            gurkenLat = null;
                            gurkenLon = null;
                        }


                        

                    });

                    marker.bindPopup("<b>HP der Gurke</b><br>" + gurkeHP).openPopup();
                    

                    let zielLat;
                    let ZielLon;
                    let Spielerentfernung;
                    let random1 = ((Math.random() * 2 - 1) * 0.0000002);
                    let random2 = ((Math.random() * 2 -1) * 0.0000002);

                    

                    setInterval(() => {

                            if (pause) return;
                            
                            Spielerentfernung = entfernungInMetern(gurkenLat, gurkenLon, playerLat, playerLon);
                            if (Spielerentfernung < 60) {
                                zielLat = playerLat;
                                zielLon = playerLon;
                                

                            } else {
                                zielLat = gurkenLat + random1;
                                zielLon = gurkenLon + random2;
                                
                            }
                            console.log(Spielerentfernung);

                            

                            const dLat = zielLat - gurkenLat;
                            const dLon = zielLon - gurkenLon;

                            dist = Math.sqrt(dLat * dLat + dLon * dLon);

                            console.log(dist);

                            let step = 0.0000006;

                            const dirLat = dLat / dist;
                            const dirLon = dLon / dist;

                            gurkenLat += dirLat * step;
                            gurkenLon += dirLon * step;

                            marker.setLatLng([gurkenLat, gurkenLon]);

                            if (Spielerentfernung < 10) {
                                
                                
                                console.log("playerHP: " + playerHP);

                                if (!unverwundbar) {
                                    playerHP = playerHP -0.5;
                                    unverwundbar = true;
                                    const unverwundbarTimeout = setTimeout(unverwundbarStop, 5000);
                                }
                            }

                            

                        }, 50)

                        setInterval(() => {
                            random1 = ((Math.random() * 2 - 1) * 0.0000002);
                            random2 = ((Math.random() * 2 -1) * 0.0000002);
                        }, 10000)

                        setInterval(() => {
                            if (timer > 10) {
                                timer = 0;
                            } else {
                                timer = timer + 0.1;
                            }

                            let timerDisplay = document.getElementById("attackTimer");
                            timerDisplay.innerText = timer.toFixed(1);
                            marker.setPopupContent("<b>HP der Gurke</b><br>" + gurkeHP.toFixed(1));

                        }, 50)

                        




                }
            }

            
            const distToLastPolygonSpawn = entfernungInMetern(lastPolygonLat, lastPolygonLon, playerLat, playerLon);
            console.log("Dist to last polygon spawn " + distToLastPolygonSpawn);

            if (distToLastPolygonSpawn > 500) {
                lastPolygonLat = playerLat;
                lastPolygonLon = playerLon;
                for (let i = 0; i < 3; i++) {
                    let [polygonLat, polygonLon] = randomGurkenSpawn(playerLat, playerLon, 50, 500);
                    let polygonBounds = [
                        randomGurkenSpawn(polygonLat, polygonLon, 90, 260),
                        randomGurkenSpawn(polygonLat, polygonLon, 90, 260),
                        randomGurkenSpawn(polygonLat, polygonLon, 90, 260)
                        
                    ];
                    var polygon = L.polygon(polygonBounds, {color: "Tomato"}).addTo(map);

                    const polygonCalculation = polygonBounds.map(([lat, lng]) => [lng, lat]);
                    
                }
                

            }

        });

        

        




    </script>
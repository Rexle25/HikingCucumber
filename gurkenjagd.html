<!DOCTYPE html>
<head>
    <title>Gurkenjagd</title>
     <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>

      <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>

     <link rel="stylesheet" href="style.css">
</head>

<body>

    <script src="achievments.js"></script> 
    <script src="getRegionData.js"></script> 

     <div id="map"></div>

     <script>
     
     var map = L.map('map').setView([47.505, 7.09], 13);
     L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);



     </script>

     <script>
        

        setInterval(() => {
            achievments();


        }, 10000);

        


     </script>
    
    <script>

        function tagsEnthält(tags, suchwort) {
            const suchwortKlein = suchwort.toLowerCase();

            for (let key in tags) {
                const keyKlein = key.toLowerCase();
                const valueKlein = String(tags[key]).toLowerCase();

                if (keyKlein.includes(suchwortKlein) || valueKlein.includes(suchwortKlein)) {
                    return true;
                }
            }

            return false;
        }


        let lat;
        let lon;
        let random;
        let random2;
        let daten;
        let wald;
        let wasser;
        let busch;
        let klippe;
        let siedlung;
        let feucht;
        let geoTags;
        let zug;
        let steinbruch;
        let parkplatz;
        let restaurant;
        let player;
        let vorherigeLat;
        let vorherigeLon;

        

        navigator.geolocation.getCurrentPosition(

        pos => {

            lat = pos.coords.latitude;
            lon = pos.coords.longitude;

            player = L.circle([lat, lon], {
                    color: 'red',
                    fillColor: '#f03',
                    fillOpacity: 0.5,
                    radius: 10
            }).addTo(map); 
            

            getRegionData(lat, lon).then(data => {
                console.log("Gefundene Objekte:");
                data.elements.forEach((el) => {
                    const tags = el.tags || {};

                    geoTags = tags;
                    console.log(geoTags);
                    console.log(tagsEnthält(tags, "forest"));
                    if (tagsEnthält(tags, "forest")) {
                        wald = true;
                    }
                    if (tagsEnthält(tags, "residential")) {
                        siedlung = true;
                        console.log("Siedlung " + siedlung);
                    }
                    if (tagsEnthält(tags, "water")) {
                        wasser = true;
                        console.log("Wasser " + wasser);
                    }
                    if (tagsEnthält(tags, "scrub")) {
                        busch = true;
                        console.log("Scrub " + busch);
                    }
                    if (tagsEnthält(tags, "wet")) {
                        feucht = true;
                        console.log("Feucht " + feucht);
                    }
                    if (tagsEnthält(tags, "cliff")) {
                        klippe = true;
                        console.log("Klippe " + klippe);
                    }
                    if (tagsEnthält(tags, "rail")) {
                        zug = true;
                        console.log("Zug " + zug);
                    }
                    if (tagsEnthält(tags, "quarry")) {
                        steinbruch = true;
                        console.log("Steinbruch " + steinbruch);
                    }
                    if (tagsEnthält(tags, "parking")) {
                        parkplatz = true;
                        console.log("Parkplatz " + parkplatz);
                    }
                    if (tagsEnthält(tags, "restaurant")) {
                        restaurant = true;
                        console.log("Restaurant " + restaurant);
                    }



                    
                });
                daten = data.elements;
                console.log(daten);
                console.log(data);
                
            });

      
            setTimeout(() => {
                function weighted_random(items, weights) {
                    let i;
                    for (i = 1; i < weights.length; i++)
                        weights[i] += weights[i - 1];

                    const random = Math.random() * weights[weights.length - 1];
                    for (i = 0; i < weights.length; i++)
                        if (weights[i] > random)
                            break;

                    return items[i];
                }

                for (let i = 0; i < 30; i++) {
                    let random = (Math.random() * 0.004) - 0.002;
                    let random2 = (Math.random() * 0.004) - 0.002;
                    let markerLat = lat + random;
                    let markerLon = lon + random2;

                    let items = ["Gurke", "Goldene Gurke", "Seltene Gurke", "Ungewöhnliche Gurke", "Legendäre Gurke", "Wandergurke", "Essiggurke", "Waldgurke", "Hausgurke", "Wassergurke", "Buschgurke", "Klippengurke", "Feuchtgurke", "Schienengurke", "Steinbruchgurke", "Parkinggurke", "Fressgurke"];
                    let weights = [0.3, 0.07, 0.09, 0.25, 0.04, 0.2, 0.3, 0.4, 0.3, 0.3, 0.5, 0.3, 0.3, 0.1, 0.3, 0.1, 0.2];

                    let aktuelleGurke = weighted_random(items, [...weights]);

                    let marker = L.marker([markerLat, markerLon]).addTo(map).on('click', function(e) {
                        navigator.geolocation.getCurrentPosition(pos => {
                            const lat = pos.coords.latitude;
                            const lon = pos.coords.longitude;
                            const dist = Math.hypot(markerLat - lat, markerLon - lon) * 111000;

                            if (dist < 100) {
                                addPoints(1);
                                map.removeLayer(marker);
                                let temporäreGurke = Number(localStorage.getItem(aktuelleGurke)) || 0;
                                temporäreGurke = temporäreGurke + 1;
                                localStorage.setItem(aktuelleGurke, temporäreGurke);

                                alert("Gesammelte " + aktuelleGurke + ":" + temporäreGurke);

                                console.log("Gesammelte " + aktuelleGurke + ":" + temporäreGurke);
                            } else {
                                alert("Du bist noch " + Math.round(dist) + " Meter von diesem Ort entfernt");
                            }
                        });
                    });

                    console.log("Wald ist " + wald);

                    if (!wald && aktuelleGurke === "Waldgurke") {
                        console.log("Kein Wald vorhanden. Waldgurke wird entfernt");
                        map.removeLayer(marker);
                        
                    }
                    if (!wasser && aktuelleGurke === "Wassergurke") {
                        console.log("Kein Wasser vorhanden. Wassergurke wird entfernt");
                        map.removeLayer(marker);
                        
                    }
                    if (!siedlung && aktuelleGurke === "Hausgurke") {
                        console.log("Kein Wohnbereich vorhanden. Hausgurke wird entfernt");
                        map.removeLayer(marker);
                        
                    }
                    if (!busch && aktuelleGurke === "Buschgurke") {
                        console.log("Kein Busch vorhanden. Buschgurke wird entfernt");
                        map.removeLayer(marker);
                        
                    }
                    if (!klippe && aktuelleGurke === "Klippengurke") {
                        console.log("Keine Klippe vorhanden. Klippengurke wird entfernt");
                        map.removeLayer(marker);
                        
                    }
                    if (!klippe && aktuelleGurke === "Feuchtgurke") {
                        console.log("Kein Feuchtgebiet vorhanden. Feuchtgurke wird entfernt");
                        map.removeLayer(marker);
                        
                    }
                    if (!zug && aktuelleGurke === "Schienengurke") {
                        console.log("Keine Schienen vorhanden. Schienengurke wird entfernt");
                        map.removeLayer(marker);
                        
                    }
                    if (!steinbruch && aktuelleGurke === "Steinbruchgurke") {
                        console.log("Kein Steinbruch vorhanden. Steinbruchgurke wird entfernt");
                        map.removeLayer(marker);
                        
                    }
                    if (!restaurant && aktuelleGurke === "Fressgurke") {
                        console.log("Kein Restaurant vorhanden. Fressgurke wird entfernt");
                        map.removeLayer(marker);
                        
                    }
                    if (!parkplatz && aktuelleGurke === "Parkinggurke") {
                        console.log("Kein Parkplatz vorhanden. Parkinggurke wird entfernt");
                        map.removeLayer(marker);
                        
                    }

                }
            }, 20000);

            navigator.geolocation.watchPosition( pos => {
            lat = pos.coords.latitude;
            lon = pos.coords.longitude;


            
            player.setLatLng([lat, lon]);
            
            
            
            })



            


        }


        )

        



        

        

    </script>